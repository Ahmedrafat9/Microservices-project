apiVersion: batch/v1
kind: Job
metadata:
  name: kubelinter-check
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-weight: "-1"
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: kubelinter
        image: stackrox/kube-linter:latest
        command: ["/bin/sh", "-c"]
        args:
        - |
          echo "ğŸ” Checking manifests for security and reliability issues..."
          
          # Clone the repo and check manifest files
          apk add --no-cache git
          git clone https://github.com/Ahmedrafat9/Microservices-project.git /repo
          cd /repo
          
          # Check if kubernetes-manifests directory exists
          if [ ! -d "kubernetes-manifests" ]; then
            echo "âŒ 'kubernetes-manifests' directory not found!"
            exit 1
          fi
          
          # Run KubeLinter on the kubernetes-manifests directory - only check privileged containers and missing probes
          echo "ğŸ“‹ Checking for privileged containers and missing probes..."
          kube-linter lint "kubernetes-manifests" \
            --include privileged-containers,no-liveness-probe,no-readiness-probe \
            --format json > /tmp/results.json || true
          
          # Show results in a readable format
          if [ -s /tmp/results.json ]; then
            echo ""
            echo "ğŸš¨ Issues Found:"
            cat /tmp/results.json | jq -r '.Reports[]? | "âŒ \(.Check): \(.Object.K8sObject.Kind)/\(.Object.K8sObject.Name) - \(.Diagnostic.Message)"'
            
            # Check for privileged containers and missing probes
            CRITICAL=$(cat /tmp/results.json | jq -r '.Reports[]? | select(.Check | contains("privileged-containers") or contains("no-liveness-probe") or contains("no-readiness-probe")) | .Check' | wc -l)
            
            if [ "$CRITICAL" -gt 0 ]; then
              echo ""
              echo "ğŸ’¥ Found privileged containers or missing health probes!"
              echo "ğŸš« Deployment blocked - please fix:"
              echo "   â€¢ Remove privileged: true from containers"
              echo "   â€¢ Add livenessProbe to containers"
              echo "   â€¢ Add readinessProbe to containers"
              exit 1
            fi
            
            echo ""
            echo "âš ï¸  Found issues but none are critical - deployment will continue"
          else
            echo "âœ… No issues found - all checks passed!"
          fi